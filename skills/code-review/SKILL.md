---
name: code-review
description: コード変更のレビューを実施し、バグ・セキュリティ、可読性・保守性、パフォーマンス、影響範囲の観点でチェックリスト形式のフィードバックを提供する。`gh pr`コマンドによるPR差分や`git diff`による変更差分をレビュー対象とする。「コードレビューして」「PRをレビューして」「この変更を確認して」などで起動。
---

# Code Review

## ワークフロー

1. **差分の取得**: `gh pr diff`または`git diff`で変更内容を取得
2. **変更ファイルの確認**: 変更されたファイルを読み込み、変更内容を把握
3. **影響範囲の分析**: 変更された関数・クラスの呼び出し元をGrepで調査
4. **チェックリスト形式でレビュー結果を出力**

## 差分の取得方法

### PRレビューの場合

```bash
# PR番号を指定
gh pr diff <PR番号>

# 現在のブランチのPR
gh pr diff
```

### ローカル変更のレビューの場合

```bash
# ステージング済みの変更
git diff --cached

# 直前のコミットとの差分
git diff HEAD~1

# 特定ブランチとの差分
git diff main...HEAD
```

## レビュー観点

各観点でチェックし、問題があれば指摘する。

### 1. バグ・セキュリティ

- [ ] NullPointerException / undefined参照の可能性
- [ ] 境界値・エッジケースの考慮漏れ
- [ ] 入力値のバリデーション不足
- [ ] SQLインジェクション / XSS / コマンドインジェクション
- [ ] 機密情報（APIキー、パスワード）のハードコード
- [ ] 認証・認可のバイパス可能性
- [ ] エラーハンドリングの漏れ

### 2. 可読性・保守性

- [ ] 関数・変数名が意図を表現しているか
- [ ] 複雑すぎるロジック（ネストが深い、条件分岐が多い）
- [ ] マジックナンバー・マジックストリングの使用
- [ ] 重複コード（DRY原則違反）
- [ ] 単一責任原則の違反
- [ ] コメントが必要な非自明なロジック

### 3. パフォーマンス

- [ ] N+1クエリ問題
- [ ] ループ内での重い処理（DB/API呼び出し）
- [ ] 不要なデータの読み込み
- [ ] メモリリークの可能性
- [ ] 非効率なアルゴリズム（O(n²)が避けられる場合など）

### 4. 影響範囲

- [ ] 変更した関数・メソッドの呼び出し元への影響
- [ ] 公開API（public interface）の破壊的変更
- [ ] 他モジュールへの副作用
- [ ] テストコードへの影響
- [ ] 設定ファイルやスキーマの変更による影響

## 影響範囲分析の手順

影響範囲分析の詳細な手順は [references/impact-analysis.md](references/impact-analysis.md) を参照。

## 出力フォーマット

レビュー結果は以下の形式で出力する:

```markdown
## レビュー結果

### サマリー
- 変更ファイル数: X
- 追加行数: +Y / 削除行数: -Z
- 重要度: 高/中/低

### チェックリスト

#### バグ・セキュリティ
- [x] NullPointerException / undefined参照: **問題なし**
- [ ] 入力値のバリデーション: **要確認** - `src/api/handler.ts:42`でユーザー入力を直接使用

#### 可読性・保守性
- [x] 命名: **良好**
- [ ] 複雑度: **要改善** - `processData`関数のネストが5段階

#### パフォーマンス
- [x] N+1クエリ: **問題なし**
- [x] ループ内処理: **問題なし**

#### 影響範囲
- [ ] 呼び出し元への影響: **要確認**
  - `UserService.getUser()` → 3箇所から呼び出し
  - 戻り値の型が変更されているため、呼び出し元の修正が必要

### 詳細な指摘事項

#### [重要度: 高] セキュリティ - SQLインジェクションの可能性
**ファイル**: `src/db/query.ts:28`
**問題**: ユーザー入力を直接SQLクエリに埋め込んでいる
**推奨**: プリペアドステートメントを使用する

#### [重要度: 中] 可読性 - 複雑なネスト
**ファイル**: `src/service/processor.ts:55-80`
**問題**: if文のネストが5段階になっている
**推奨**: 早期リターンパターンまたは関数分割を検討
```
